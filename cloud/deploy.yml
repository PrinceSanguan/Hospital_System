prod:
  # Setup and configure the Laravel application
  deploy-steps:
    - "php artisan down || true"
    - "composer install --no-dev --optimize-autoloader"
    - "php artisan migrate --force"
    - "php artisan storage:link || true"
    - "php artisan config:cache"
    - "php artisan route:cache"
    - "php artisan view:cache"
    - "php artisan vite:fix-manifest --force"
    - "php artisan up"

  # Set up and build the frontend assets
  build-steps:
    - "echo 'Setting up Node.js and NPM...'"
    - "nvm install 20 && nvm use 20"
    - "echo 'Installing NPM dependencies...'"
    - "npm ci --no-audit"
    - "echo 'Building frontend assets...'"
    - "npm run build:cloud"
    - "echo 'Verifying build...'"
    - "ls -la public/build/"
    - "echo 'Fixing manifest permissions...'"
    - "chmod -R 775 public/build"

  # Explicitly include the public/build directory
  directory-include:
    - "public/build"

  # Start fresh with each deployment
  directory-clean:
    - "bootstrap/cache"

  # Make sure logs are accessible
  log-files:
    - "storage/logs/laravel.log"

  # Persist storage between deployments
  persist-directories:
    - "storage"

# Don't create subdirectories for PR deployments
local:
  clone-directory: "/"

# Don't use custom hooks or deploy script
pull_requests: true
