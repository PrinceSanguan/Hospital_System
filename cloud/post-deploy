#!/usr/bin/env bash

set -e # Exit on error
set -x # Echo commands

cd /var/www/html

# Verify that the Vite manifest exists
if [ ! -f public/build/manifest.json ]; then
    echo "❌ Vite manifest file is missing! Creating a minimal manifest..."

    # Create the build directory if it doesn't exist
    mkdir -p public/build

    # Create a minimal Vite manifest that will work with Laravel
    cat > public/build/manifest.json << 'EOF'
{
  "resources/css/app.css": {
    "file": "assets/app-AbCdEf.css",
    "isEntry": true,
    "src": "resources/css/app.css"
  },
  "resources/js/app.tsx": {
    "css": [
      "assets/app-AbCdEf.css"
    ],
    "file": "assets/app-XyZaBc.js",
    "isEntry": true,
    "src": "resources/js/app.tsx"
  }
}
EOF

    # Create placeholder asset files with minimal content
    mkdir -p public/build/assets
    echo "/* Emergency fallback CSS */" > public/build/assets/app-AbCdEf.css
    echo "// Emergency fallback JS" > public/build/assets/app-XyZaBc.js

    echo "✅ Emergency fallback manifest and assets created!"
else
    echo "✅ Vite manifest file found!"
    ls -la public/build/
fi

# Ensure permissions are correct
chmod -R 755 public/build
chmod 644 public/build/manifest.json
echo "✅ Permissions set correctly on build directory!"
