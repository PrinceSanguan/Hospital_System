#!/usr/bin/env bash

set -e # Exit on error
set -x # Echo commands

cd /var/www/html

echo "Running Vite manifest fix command..."
php artisan vite:fix-manifest --force

# Verify that the Vite manifest exists (should be created by the command, this is a double-check)
if [ ! -f public/build/manifest.json ]; then
    echo "❌ Artisan command failed! Manually creating Vite manifest file..."

    # Create the build directory if it doesn't exist
    mkdir -p public/build/assets

    # Create a minimal Vite manifest that will work with Laravel
    cat > public/build/manifest.json << 'EOF'
{
  "resources/css/app.css": {
    "file": "assets/app-fallback.css",
    "isEntry": true,
    "src": "resources/css/app.css"
  },
  "resources/js/app.tsx": {
    "file": "assets/app-fallback.js",
    "isEntry": true,
    "src": "resources/js/app.tsx"
  }
}
EOF

    # Create placeholder asset files with minimal content
    echo "/* Emergency fallback CSS */" > public/build/assets/app-fallback.css
    echo "// Emergency fallback JS" > public/build/assets/app-fallback.js

    echo "✅ Emergency fallback manifest and assets created manually!"
else
    echo "✅ Vite manifest file verified!"
    ls -la public/build/
fi

# Ensure permissions are correct
chmod -R 755 public/build
chmod 644 public/build/manifest.json
chmod 644 public/build/assets/app-fallback.css
chmod 644 public/build/assets/app-fallback.js
echo "✅ Permissions set correctly on build directory!"
